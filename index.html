<html>

<body>
    <div id="g"></div>
    <style>
        #g {
            display: fixed;
            inset: 0;
            display: grid;
            grid-template-columns: repeat(32, 1fr);
            grid-template-rows: repeat(32, 1fr);
            color: #026;
            background: #026;
            aspect-ratio: 1;
            overflow: hidden;
        }

        @keyframes b {
            from {
                color: #026;
            }

            to {
                color: #3b7;
            }
        }

        @keyframes l {
            from {
                color: #3b7;
            }

            to {
                color: #026;
            }
        }

        @keyframes c {
            0% {
                color: #3b7;
            }

            80% {
                color: #d80;
            }

            100% {
                color: #026;
            }
        }


        #g>* {
            position: relative;
            width: min(4dvw, 4dvh);
            aspect-ratio: 1;
            border: 0;
            color: transparent;
            background: transparent;

            * {
                border-radius: 100%;
                display: block;
                position: absolute;
                top: -25%;
                left: -25%;
                bottom: -25%;
                right: -25%;
                background: transparent radial-gradient(circle at center, currentColor, #0260 65%);
            }

            &.a {
                color: #3b7;
            }

            &.b {
                animation: b 300ms;
            }

            &.l {
                animation: l 300ms;
            }

            &.c {
                animation: c 300ms;
            }
        }
    </style>
    <script>
        const width = 32
        const column = v => (v * width) || 1
        const d = document
        const ce = t => d.createElement(t)
        const ac = (e, c) => e.appendChild(c);
        const t = setTimeout
        const g = d.getElementById('g')
        const cl = e => e.classList
        const clear = (e, r) => cl(e).remove(r)
        const set = (e, a, r) => {
            cl(e).add(a);
            if (r) {
                t(() => clear(e, r), 50)
            }
        }
        const elements = Array.from({ length: width })
            .map((z, y) => Array.from({ length: width })
                .map((z, x) => {
                    const e = ce('button')
                    e.onclick = () => cl(e).toggle('a')
                    ac(e, ce('i'))
                    ac(g, e)
                    return e
                }))

        const is_alive = (e) => e && cl(e).contains('a')
        const neighbors = (y, x) => {
            let n = 0;
            for (let k = y - 1; k < y + 2; k++) {
                for (let j = x - 1; j < x + 2; j++) {
                    if (k != y || j != x) {
                        if (is_alive(elements[k]?.[j])) {
                            n++;
                        }
                    }
                }
            }
            return n
        }
        let running = false;
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            const audioCtx = new AudioContext();
            const source = audioCtx.createMediaStreamSource(stream);

            const analyser = audioCtx.createAnalyser();
            analyser.fftSize = width * width * 2;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            source.connect(analyser);

            running = true;

            const draw = () => {
                requestAnimationFrame(draw);

                analyser.getByteTimeDomainData(dataArray);

                for (let i in dataArray) {
                    let y = Math.floor(i / width);
                    let x = i % width;
                    let v = dataArray[i] / 2.0;
                    const e = elements[y][x];
                    if (v > 80) {
                        set(e, 'a')
                        if (v > 90) {
                            set(e, 'c', 'a')
                        }
                    } else if (v < 40) {
                        clear(a, 'a')
                    }
                }
            }
            draw();
        })
        const step = () => {
            for (let y in elements) {
                for (let x in elements[y]) {
                    const e = elements[y][x];
                    ['b', 'l', 'c'].map(l => clear(e, l));
                    let m = neighbors(parseInt(y), parseInt(x));
                    const a = is_alive(e)
                    if (a && m < 2) {
                        set(e, 'l', 'a')
                    } else if (a && m > 3) {
                        set(e, 'c', 'a')
                    } else if (!a && m == 3) {
                        set(e, 'b');
                        t(() => set(e, 'a', 'b'), 250)
                    }
                }
            }
        }
        setInterval(step, 600);
    </script>
</body>

</html>